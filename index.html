<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerador de Curr√≠culos Profissional</title>

<!-- LIBS -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docshift@latest/dist/docshift.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* --- Global & Fonts --- */
@import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Merriweather:wght@400;700&family=Roboto:wght@400;700&display=swap');

:root {
    --accent-color-default: #4a90e2;
    --background-color: #f7f8fa;
    --panel-background: #ffffff;
    --text-primary: #2c3e50;
    --text-secondary: #5a6e82;
    --border-color: #e4e7eb;
    --danger-color: #e74c3c;
    --premium-color: #f39c12;
}

body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    padding: 0;
    background: var(--background-color);
    color: var(--text-primary);
}

/* --- Main Layout & Header --- */
header {
    background: var(--panel-background);
    color: var(--text-primary);
    padding: 10px 40px;
    text-align: left;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    border-bottom: 1px solid var(--border-color);
}
header h1 {
    font-size: 1.5em;
    margin: 0;
}

.main-container {
    display: flex;
    gap: 30px;
    padding: 20px;
    align-items: flex-start;
}

#editor-panel {
    flex: 1 1 60%;
    background: var(--panel-background);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 3px rgba(0,0,0,0.02);
}
.editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}
.editor-header h2 {
    margin: 0;
    font-size: 1.2em;
    color: var(--text-primary);
}

#preview-panel {
    flex: 1 1 40%;
    position: sticky;
    top: 20px;
    max-height: 95vh;
    overflow-y: auto;
}
#preview {
    background: var(--panel-background);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    padding: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

/* --- Form Elements & Sections --- */
#cvForm {
    padding: 20px;
}
.form-section {
    margin-bottom: 25px;
    padding-bottom: 25px;
    border-bottom: 1px solid var(--border-color);
}
.form-section:last-child {
    border-bottom: none;
}
.form-section h3, label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}
.form-section h3 {
    margin-top: 0;
    font-size: 1.1em;
    color: var(--text-primary);
}
label {
    font-weight: bold;
    font-size: 0.9em;
    color: var(--text-secondary);
}
.icon-select {
    font-size: 0.8em;
    padding: 2px;
    border-radius: 4px;
    border: 1px solid var(--border-color);
    background-color: var(--background-color);
}
input[type="text"], input[type="email"], input[type="tel"], textarea, select {
    width: 100%;
    padding: 10px;
    margin-top: 0;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    box-sizing: border-box;
    font-size: 1em;
    transition: border-color 0.2s, box-shadow 0.2s;
}
input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--accent-color, var(--accent-color-default));
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}
input[type="file"] {
    font-size: 0.9em;
}
textarea {
    resize: vertical;
    min-height: 80px;
}

/* --- Buttons & Controls --- */
button, .button {
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: bold;
    transition: filter 0.2s;
}
button:hover, .button:hover {
    filter: brightness(95%);
}
.button-add {
    background: none;
    border: 1px dashed var(--border-color);
    color: var(--text-secondary);
    width: 100%;
    margin-top: 10px;
}
.button-add:hover {
    background: #fcfcfc;
    border-color: var(--accent-color, var(--accent-color-default));
    color: var(--accent-color, var(--accent-color-default));
}
.button-premium {
    background-color: var(--premium-color);
    color: white;
}
.button-secondary {
    background-color: #ecf0f1;
    color: var(--text-secondary);
}

#savedCvArea {
    padding: 20px;
    background-color: #f7f8fa;
    border-bottom: 1px solid var(--border-color);
}
.layout-controls {
    display: flex;
    gap: 20px;
    align-items: flex-end;
}
.layout-controls > div {
    display: flex;
    flex-direction: column;
}
.layout-controls input[type="color"] {
    width: 60px;
    height: 35px;
    padding: 2px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
}

/* --- Dynamic Entry Fields --- */
.experiencia-entry, .formacao-entry, .habilidade-entry, .projeto-entry, .link-entry {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-bottom: 10px;
    border: 1px solid var(--border-color);
    padding: 8px;
    border-radius: 6px;
    background-color: var(--background-color);
}
.drag-handle {
    cursor: move;
    color: #b3b3b3;
    padding: 0 8px;
}
.drag-handle:hover {
    color: #333;
}
.entry-content {
    flex-grow: 1;
}
.entry-content input, .entry-content textarea {
    margin-bottom: 5px;
}
.entry-content > *:last-child {
    margin-bottom: 0;
}
.habilidade-entry .entry-content, .link-entry .entry-content {
    display: flex;
    gap: 10px;
}
.remove-btn {
    background-color: transparent;
    color: var(--text-secondary);
    padding: 5px;
}
.remove-btn:hover {
    background-color: var(--danger-color);
    color: white;
}

/* --- Preview Actions & Dropdown --- */
.preview-actions {
    display: flex;
    gap: 10px;
    padding: 10px;
    background: #eef1f4;
    border-radius: 8px;
    margin-bottom: 15px;
    align-items: center;
}
.dropdown {
    position: relative;
    display: inline-block;
}
.dropdown .dropbtn {
    background-color: white;
    color: var(--text-primary);
}
.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
    border-radius: 6px;
}
.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}
.dropdown-content a:hover {background-color: #f1f1f1}
.dropdown:hover .dropdown-content {
    display: block;
}

/* --- Misc & Helpers --- */
.error-message {
    color: var(--danger-color);
    font-size: 0.85em;
    margin-top: 4px;
    display: block;
    height: 1em;
}
input.error {
    border-color: var(--danger-color) !important;
    background-color: #fff6f4;
}
.sortable-ghost {
    opacity: 0.4;
    background-color: #cce5ff;
}
.font-lato { font-family: 'Lato', sans-serif; }
.font-roboto { font-family: 'Roboto', sans-serif; }
.font-merriweather { font-family: 'Merriweather', serif; }

/* --- TEMPLATE-SPECIFIC STYLES --- */
#preview h3 > i,
#preview p > i {
    margin-right: 8px;
    width: 1.1em;
    text-align: center;
    color: var(--accent-color, var(--accent-color-default));
}
#preview.template-classico h2 {
    color: var(--text-primary);
    border-bottom: 2px solid var(--accent-color, var(--accent-color-default));
    padding-bottom: 10px;
    margin-bottom: 15px;
    font-size: 1.8em;
}
#preview.template-classico h3 {
    color: var(--accent-color, var(--accent-color-default));
    margin-top: var(--section-spacing, 25px);
    margin-bottom: 10px;
    font-size: 1.2em;
    text-transform: uppercase;
    letter-spacing: 1px;
}
#preview.template-classico p, #preview.template-classico li {
    line-height: 1.7;
    color: var(--text-secondary);
}
#preview.template-classico ul {
    list-style-type: none;
    padding-left: 0;
}
#preview.template-classico li {
    margin-bottom: 15px;
    padding-left: 15px;
    border-left: 3px solid #bdc3c7;
}
#preview.template-classico strong {
    color: var(--text-primary);
}
#preview.template-classico hr {
    border: 0;
    height: 1px;
    background-color: var(--border-color);
    margin: 25px 0;
}
#preview.template-moderno {
    display: flex;
    background-color: var(--panel-background);
    min-height: 800px;
}
.template-moderno .moderno-sidebar {
    width: 35%;
    background-color: var(--text-primary);
    color: white;
    padding: 30px;
    box-sizing: border-box;
}
.template-moderno .moderno-sidebar h3 {
    color: #ecf0f1;
    font-size: 1.1em;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 1px solid #7f8c8d;
    padding-bottom: 5px;
    margin-top: var(--section-spacing, 20px);
}
.template-moderno .moderno-sidebar p {
    color: #bdc3c7;
    line-height: 1.6;
    font-size: 0.9em;
    word-wrap: break-word;
}
.template-moderno .moderno-sidebar ul {
    list-style: none;
    padding: 0;
}
.template-moderno .moderno-sidebar li {
    color: #bdc3c7;
    margin-bottom: 5px;
}
.template-moderno .moderno-main {
    width: 65%;
    padding: 30px;
    box-sizing: border-box;
}
.template-moderno .moderno-main h2 {
    font-size: 2.5em;
    color: var(--text-primary);
    margin: 0 0 20px 0;
    padding: 0;
    border: none;
}
.template-moderno .moderno-main h3 {
    color: var(--accent-color, #2980b9);
    font-size: 1.3em;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 8px;
    margin-top: var(--section-spacing, 20px);
    margin-bottom: 15px;
    text-transform: uppercase;
}
.template-moderno .job, .template-moderno .education {
    margin-bottom: 20px;
}
.template-moderno .job h4, .template-moderno .education h4 {
    margin: 0;
    color: var(--text-primary);
    font-weight: 700;
    font-size: 1.1em;
}
.template-moderno .job h5, .template-moderno .education h5 {
    margin: 2px 0 5px 0;
    color: var(--text-secondary);
    font-weight: 400;
    font-style: italic;
}
.template-moderno .job p {
    margin: 5px 0 0 0;
    color: #555;
    line-height: 1.5;
}
.profile-pic {
    border-radius: 50%;
    width: 120px;
    height: 120px;
    object-fit: cover;
    margin-bottom: 15px;
    border: 3px solid var(--border-color);
}
#preview.template-classico .profile-pic {
    float: right;
    margin-left: 20px;
}
#preview.template-moderno .profile-pic {
    display: block;
    margin-left: auto;
    margin-right: auto;
    border-color: #7f8c8d;
}
</style>
</head>
<body>

<header>
  <h1>Gerador de Curr√≠culos Profissional</h1>
</header>

<main class="main-container">
    <div id="editor-panel">
        <div class="editor-header">
            <h2>Editor de Curr√≠culo</h2>
            <div id="loginStatus">
                <span id="userEmail"></span>
                <button id="loginBtn" class="button-secondary" onclick="loginGoogle()">Login com Google</button>
                <button id="logoutBtn" class="button-secondary" onclick="logout()" style="display:none;">Logout</button>
            </div>
        </div>

        <div id="savedCvArea" style="display:none;">
            <h4>Meus Curr√≠culos</h4>
            <select id="savedCvSelect"></select>
            <button type="button" onclick="carregarCurriculo()">Carregar</button>
            <button type="button" class="remove-btn" onclick="deletarCurriculo()">Deletar</button>
        </div>

        <form id="cvForm">
            <div class="form-section">
                <h3>Design e Layout</h3>
                <div class="layout-controls">
                    <div>
                        <label for="template-select">Modelo</label>
                        <select id="template-select" name="template-select">
                            <option value="classico">Cl√°ssico</option>
                            <option value="moderno" disabled>Moderno (Premium)</option>
                        </select>
                    </div>
                    <div>
                        <label for="accent-color">Cor Destaque</label>
                        <input type="color" id="accent-color" value="#4a90e2">
                    </div>
                    <div>
                        <label for="font-select">Fonte</label>
                        <select id="font-select">
                            <option value="lato">Lato</option>
                            <option value="roboto">Roboto</option>
                            <option value="merriweather">Merriweather</option>
                        </select>
                    </div>
                    <div>
                        <label for="margin-slider">Margens Laterais</label>
                        <input type="range" id="margin-slider" min="20" max="60" value="30">
                        <span id="margin-value">30px</span>
                    </div>
                    <div>
                        <label for="spacing-slider">Espa√ßamento de Se√ß√£o</label>
                        <input type="range" id="spacing-slider" min="15" max="40" value="25">
                        <span id="spacing-value">25px</span>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Informa√ß√µes Pessoais</h3>
                <label>Nome</label>
                <input type="text" id="nome" placeholder="Seu nome completo">

                <label for="profilePicInput">Foto de Perfil (Opcional)</label>
                <input type="file" id="profilePicInput" accept="image/*" onchange="handleProfilePicUpload(this.files[0])">
                <img id="profilePicPreview" src="" alt="Preview da Foto" style="max-width: 100px; border-radius: 50%; margin-top: 10px; display: none;">
                <input type="hidden" id="profilePicUrl" value="">

                <label for="email">Email <select class="icon-select" id="email-icon"><option value="">Sem √çcone</option><option value="fas fa-envelope">Envelope</option><option value="fas fa-at">At</option></select></label>
                <input type="email" id="email" placeholder="seu@email.com">
                <span class="error-message" id="email-error"></span>

                <label for="telefone">Telefone <select class="icon-select" id="telefone-icon"><option value="">Sem √çcone</option><option value="fas fa-phone">Telefone</option><option value="fab fa-whatsapp">WhatsApp</option></select></label>
                <input type="tel" id="telefone" placeholder="(11) 99999-9999">
                <span class="error-message" id="telefone-error"></span>
            </div>

            <div class="form-section">
                <h3>Resumo Profissional <select class="icon-select" id="resumo-icon"><option value="">Sem √çcone</option><option value="fas fa-user">Pessoa</option><option value="fas fa-id-card">Crach√°</option></select></h3>
                <textarea id="resumo" rows="4" placeholder="Breve descri√ß√£o sobre voc√™"></textarea>
            </div>

            <div class="form-section">
                <h3>Experi√™ncias <select class="icon-select" id="experiencias-icon"><option value="">Sem √çcone</option><option value="fas fa-briefcase">Mala</option><option value="fas fa-building">Pr√©dio</option></select></h3>
                <div id="experiencias-container"></div>
                <button type="button" class="button-add" onclick="adicionarExperiencia()">+ Adicionar Experi√™ncia</button>
            </div>

            <div class="form-section">
                <h3>Forma√ß√£o Acad√™mica <select class="icon-select" id="formacao-icon"><option value="">Sem √çcone</option><option value="fas fa-graduation-cap">Chap√©u</option><option value="fas fa-university">Universidade</option></select></h3>
                <div id="formacao-container"></div>
                <button type="button" class="button-add" onclick="adicionarFormacao()">+ Adicionar Forma√ß√£o</button>
            </div>

            <div class="form-section">
                <h3>Habilidades <select class="icon-select" id="habilidades-icon"><option value="">Sem √çcone</option><option value="fas fa-star">Estrela</option><option value="fas fa-check">Check</option></select></h3>
                <div id="habilidades-container"></div>
                <button type="button" class="button-add" onclick="adicionarHabilidade()">+ Adicionar Habilidade</button>
            </div>

            <div class="form-section">
                <h3>Idiomas <select class="icon-select" id="idiomas-icon"><option value="">Sem √çcone</option><option value="fas fa-language">Linguagem</option><option value="fas fa-globe">Globo</option></select></h3>
                <input type="text" id="idiomas" placeholder="Ex.: Ingl√™s - Avan√ßado, Espanhol - Intermedi√°rio">
            </div>

            <div class="form-section">
                <h3>Projetos <select class="icon-select" id="projetos-icon"><option value="">Sem √çcone</option><option value="fas fa-project-diagram">Diagrama</option><option value="fas fa-tools">Ferramentas</option></select></h3>
                <div id="projetos-container"></div>
                <button type="button" class="button-add" onclick="adicionarProjeto()">+ Adicionar Projeto</button>
            </div>

            <div class="form-section">
                <h3>Links Profissionais <select class="icon-select" id="links-icon"><option value="">Sem √çcone</option><option value="fas fa-link">Link</option><option value="fas fa-share-alt">Compartilhar</option></select></h3>
                <div id="links-container"></div>
                <button type="button" class="button-add" onclick="adicionarLink()">+ Adicionar Link</button>
            </div>
        </form>
    </div>

    <div id="preview-panel">
        <div class="preview-actions">
            <button type="button" onclick="novoCurriculo()">Novo</button>
            <button type="button" onclick="salvarCurriculo()">Salvar</button>
            <button type="button" onclick="salvarComoNovo()">Salvar como...</button>
            <div class="dropdown">
                <button class="dropbtn">Exportar</button>
                <div class="dropdown-content">
                    <a href="#" onclick="exportarPDF(); return false;">Exportar PDF</a>
                    <a href="#" onclick="exportarDOCX(); return false;">Exportar DOCX</a>
                </div>
            </div>
            <button type="button" class="button-premium" onclick="comprarPremium()">Seja Premium</button>
        </div>
        <div id="preview">
            <!-- O preview do curr√≠culo ser√° renderizado aqui -->
        </div>
    </div>
</main>
<script>
// Firebase Config com suas chaves
const firebaseConfig = {
  apiKey: "AIzaSyBxkmzxao2HOnGsb2Y2R7W0q9FnYdt8dJE",
  authDomain: "gerador-de-curriculos-online.firebaseapp.com",
  projectId: "gerador-de-curriculos-online",
  storageBucket: "gerador-de-curriculos-online.firebasestorage.app",
  messagingSenderId: "114021870709",
  appId: "1:114021870709:web:f73b2d837bb4b5dd7adc3c",
  measurementId: "G-HLWH9KSK0B"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// --- Upload de Foto ---
function handleProfilePicUpload(file) {
    const user = auth.currentUser;
    if (!user) {
        alert("Voc√™ precisa estar logado para fazer o upload de uma foto.");
        return;
    }
    if (!file) return;

    const profilePicPreview = document.getElementById('profilePicPreview');
    const profilePicUrlInput = document.getElementById('profilePicUrl');

    // Mostra uma preview local imediata
    const reader = new FileReader();
    reader.onload = (e) => {
        profilePicPreview.src = e.target.result;
        profilePicPreview.style.display = 'block';
    };
    reader.readAsDataURL(file);

    // Inicia o upload para o Firebase Storage
    const storageRef = storage.ref(`profile_pics/${user.uid}/${file.name}`);
    const uploadTask = storageRef.put(file);

    uploadTask.on('state_changed',
        (snapshot) => {
            // Opcional: mostrar progresso do upload
            var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            console.log('Upload is ' + progress + '% done');
        },
        (error) => {
            console.error("Erro no upload: ", error);
            alert("Falha no upload da imagem.");
        },
        () => {
            // Upload completo
            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                console.log('File available at', downloadURL);
                profilePicUrlInput.value = downloadURL; // Salva a URL no input escondido
                gerarPreview(); // Atualiza o preview do curr√≠culo
            });
        }
    );
}

// Login Google
function loginGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(result => {
      document.getElementById('userEmail').innerText = result.user.email;
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'inline';
    })
    .catch(error => alert(error.message));
}

function logout() {
  auth.signOut().then(() => {
    document.getElementById('userEmail').innerText = '';
    document.getElementById('loginBtn').style.display = 'inline';
    document.getElementById('logoutBtn').style.display = 'none';
  });
}

// Monitor login status
auth.onAuthStateChanged(user => {
  if(user){
    document.getElementById('userEmail').innerText = user.email;
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'inline';
  } else {
    document.getElementById('userEmail').innerText = '';
    document.getElementById('loginBtn').style.display = 'inline';
    document.getElementById('logoutBtn').style.display = 'none';
  }
});

// --- Fun√ß√µes para Campos Din√¢micos ---

function adicionarExperiencia() {
    const container = document.getElementById('experiencias-container');
    const newEntry = document.createElement('div');
    newEntry.className = 'experiencia-entry';
    newEntry.innerHTML = `
        <span class="drag-handle"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg></span>
        <div class="entry-content">
            <input type="text" placeholder="Cargo">
            <input type="text" placeholder="Empresa">
            <textarea rows="2" placeholder="Descri√ß√£o das atividades..."></textarea>
        </div>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remover</button>
    `;
    container.appendChild(newEntry);
}

function adicionarProjeto() {
    const container = document.getElementById('projetos-container');
    const newEntry = document.createElement('div');
    newEntry.className = 'projeto-entry';
    newEntry.innerHTML = `
        <span class="drag-handle"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg></span>
        <div class="entry-content">
            <input type="text" placeholder="Nome do Projeto">
            <input type="text" placeholder="Link do Projeto (opcional)">
            <textarea rows="2" placeholder="Descri√ß√£o do projeto..."></textarea>
        </div>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remover</button>
    `;
    container.appendChild(newEntry);
}

function adicionarLink() {
    const container = document.getElementById('links-container');
    const newEntry = document.createElement('div');
    newEntry.className = 'link-entry';
    newEntry.innerHTML = `
        <span class="drag-handle"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg></span>
        <div class="entry-content">
            <input type="text" placeholder="Nome do Link (ex: LinkedIn, GitHub)">
            <input type="text" placeholder="URL do Link">
        </div>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remover</button>
    `;
    container.appendChild(newEntry);
}

function adicionarFormacao() {
    const container = document.getElementById('formacao-container');
    const newEntry = document.createElement('div');
    newEntry.className = 'formacao-entry';
    newEntry.innerHTML = `
        <span class="drag-handle"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg></span>
        <div class="entry-content">
            <input type="text" placeholder="Curso ou Forma√ß√£o">
            <input type="text" placeholder="Institui√ß√£o de Ensino">
            <input type="text" placeholder="Ano de Conclus√£o">
        </div>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remover</button>
    `;
    container.appendChild(newEntry);
}

function adicionarHabilidade() {
    const container = document.getElementById('habilidades-container');
    const newEntry = document.createElement('div');
    newEntry.className = 'habilidade-entry';
    newEntry.innerHTML = `
        <span class="drag-handle"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg></span>
        <div class="entry-content">
            <input type="text" placeholder="Habilidade (ex: Comunica√ß√£o, Pacote Office)">
        </div>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remover</button>
    `;
    container.appendChild(newEntry);
}


// --- Valida√ß√£o ---
function validarCampos() {
    const emailInput = document.getElementById('email');
    const telefoneInput = document.getElementById('telefone');
    const emailError = document.getElementById('email-error');
    const telefoneError = document.getElementById('telefone-error');

    // Regex para email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const isEmailValid = emailRegex.test(emailInput.value) || emailInput.value.trim() === '';

    // Valida√ß√£o de Email
    if (isEmailValid) {
        emailInput.classList.remove('error');
        emailError.textContent = '';
    } else {
        emailInput.classList.add('error');
        emailError.textContent = 'Formato de email inv√°lido.';
    }

    // Para o telefone, n√£o faremos valida√ß√£o de formato por enquanto, apenas estrutural.
    // A valida√ß√£o pode ser adicionada aqui no futuro se necess√°rio.
}


// Gerar Preview
function gerarPreview() {
  validarCampos(); // Executa a valida√ß√£o a cada atualiza√ß√£o

  const template = document.getElementById('template-select').value;
  const accentColor = document.getElementById('accent-color').value;
  const fontFamily = document.getElementById('font-select').value;
  const marginValue = document.getElementById('margin-slider').value;
  const spacingValue = document.getElementById('spacing-slider').value;

  // Update slider value displays
  document.getElementById('margin-value').textContent = `${marginValue}px`;
  document.getElementById('spacing-value').textContent = `${spacingValue}px`;

  const previewElement = document.getElementById('preview');

  // Aplicar customiza√ß√µes
  previewElement.style.setProperty('--accent-color', accentColor);
  previewElement.style.padding = `30px ${marginValue}px`;
  previewElement.style.setProperty('--section-spacing', `${spacingValue}px`);
  previewElement.classList.remove('font-lato', 'font-roboto', 'font-merriweather');
  previewElement.classList.add('font-' + fontFamily);
  previewElement.classList.add('template-' + template);


  const nome = document.getElementById('nome').value;
  const email = document.getElementById('email').value;
  const telefone = document.getElementById('telefone').value;
  const resumo = document.getElementById('resumo').value;
  const idiomas = document.getElementById('idiomas').value;
  const profilePicUrl = document.getElementById('profilePicUrl').value;

  // Coletar √≠cones
  const icons = {
    email: document.getElementById('email-icon').value,
    telefone: document.getElementById('telefone-icon').value,
    resumo: document.getElementById('resumo-icon').value,
    experiencias: document.getElementById('experiencias-icon').value,
    formacao: document.getElementById('formacao-icon').value,
    habilidades: document.getElementById('habilidades-icon').value,
    idiomas: document.getElementById('idiomas-icon').value,
    projetos: document.getElementById('projetos-icon').value,
    links: document.getElementById('links-icon').value
  };
  const iconHtml = (iconClass) => iconClass ? `<i class="${iconClass}"></i> ` : '';
  const profilePicHtml = profilePicUrl ? `<img src="${profilePicUrl}" alt="Foto de Perfil" class="profile-pic">` : '';

  let html = '';

  if (template === 'classico') {
    html = `${profilePicHtml}<h2>${nome}</h2>`;
    html += `<p>${iconHtml(icons.email)}<strong>Email:</strong> ${email} | ${iconHtml(icons.telefone)}<strong>Telefone:</strong> ${telefone}</p>`;
    if (resumo) html += `<p>${iconHtml(icons.resumo)}${resumo}</p>`;
    html += '<hr>';

    // Experi√™ncias
    const experiencias = document.querySelectorAll('#experiencias-container .experiencia-entry');
    if (experiencias.length > 0 && experiencias[0].querySelector('input').value) {
      html += `<h3>${iconHtml(icons.experiencias)}Experi√™ncias</h3><ul>`;
      experiencias.forEach(entry => {
          const cargo = entry.querySelector('input:nth-child(1)').value;
          const empresa = entry.querySelector('input:nth-child(2)').value;
          const descricao = entry.querySelector('textarea').value;
          if (cargo || empresa) {
              html += `<li><strong>${cargo || 'Cargo'}</strong> em ${empresa || 'Empresa'}<br>${descricao}</li>`;
          }
      });
      html += `</ul><hr>`;
    }

    // Forma√ß√£o Acad√™mica
    const formacoes = document.querySelectorAll('#formacao-container .formacao-entry');
    if (formacoes.length > 0 && formacoes[0].querySelector('input').value) {
      html += `<h3>${iconHtml(icons.formacao)}Forma√ß√£o Acad√™mica</h3><ul>`;
      formacoes.forEach(entry => {
          const curso = entry.querySelector('input:nth-child(1)').value;
          const instituicao = entry.querySelector('input:nth-child(2)').value;
          const ano = entry.querySelector('input:nth-child(3)').value;
          if (curso || instituicao) {
              html += `<li><strong>${curso}</strong> - ${instituicao} (${ano})</li>`;
          }
      });
      html += `</ul><hr>`;
    }

    // Habilidades
    const habilidades = document.querySelectorAll('#habilidades-container .habilidade-entry input[type="text"]');
    if (habilidades.length > 0 && habilidades[0].value) {
      html += `<h3>${iconHtml(icons.habilidades)}Habilidades</h3><ul>`;
      habilidades.forEach(habilidade => {
        if (habilidade.value.trim()) {
          html += `<li>${habilidade.value.trim()}</li>`;
        }
      });
      html += `</ul><hr>`;
    }

    // Idiomas
    if (idiomas.trim()) {
        html += `<h3>${iconHtml(icons.idiomas)}Idiomas</h3><ul>`;
        idiomas.split(',').forEach(i => { if(i.trim()) html += `<li>${i.trim()}</li>`; });
        html += `</ul>`;
    }

    // Projetos
    const projetos = document.querySelectorAll('#projetos-container .projeto-entry');
    if (projetos.length > 0 && projetos[0].querySelector('input').value) {
        html += `<hr><h3>${iconHtml(icons.projetos)}Projetos</h3>`;
        projetos.forEach(entry => {
            const nome = entry.querySelector('input:nth-child(1)').value;
            const link = entry.querySelector('input:nth-child(2)').value;
            const descricao = entry.querySelector('textarea').value;
            if (nome) {
                html += `<div><h4>${nome}</h4>${link ? `<a href="${link}" target="_blank">${link}</a>` : ''}<p>${descricao}</p></div>`;
            }
        });
    }

    // Links
    const links = document.querySelectorAll('#links-container .link-entry');
    if (links.length > 0 && links[0].querySelector('input').value) {
        html += `<hr><h3>${iconHtml(icons.links)}Links Profissionais</h3><ul>`;
        links.forEach(entry => {
            const nome = entry.querySelector('input:nth-child(1)').value;
            const url = entry.querySelector('input:nth-child(2)').value;
            if (nome && url) {
                html += `<li><a href="${url}" target="_blank">${nome}</a></li>`;
            }
        });
        html += `</ul>`;
    }
  } else if (template === 'moderno') {
    // --- Template Moderno (Duas Colunas) ---
    html = `
        <div class="moderno-sidebar">
            ${profilePicHtml}
            <div class="moderno-contato">
                <h3>${iconHtml(icons.email)}Contato</h3>
                <p><strong>Email:</strong><br>${email}</p>
                <p><strong>Telefone:</strong><br>${telefone}</p>
            </div>
            <div class="moderno-habilidades">
                <h3>${iconHtml(icons.habilidades)}Habilidades</h3>
                <ul>
                    ${Array.from(document.querySelectorAll('#habilidades-container .habilidade-entry input[type="text"]'))
                             .map(h => h.value.trim() ? `<li>${h.value.trim()}</li>` : '')
                             .join('')}
                </ul>
            </div>
            <div class="moderno-idiomas">
                <h3>${iconHtml(icons.idiomas)}Idiomas</h3>
                <ul>
                    ${idiomas.trim() ? idiomas.split(',').map(i => i.trim() ? `<li>${i.trim()}</li>` : '').join('') : ''}
                </ul>
            </div>
        </div>
        <div class="moderno-main">
            <div class="moderno-header">
                <h2>${nome}</h2>
            </div>
            <div class="moderno-resumo">
                <h3>${iconHtml(icons.resumo)}Resumo Profissional</h3>
                <p>${resumo}</p>
            </div>
            <div class="moderno-experiencia">
                <h3>${iconHtml(icons.experiencias)}Experi√™ncias</h3>
                ${Array.from(document.querySelectorAll('#experiencias-container .experiencia-entry'))
                         .map(entry => {
                            const cargo = entry.querySelector('input:nth-child(1)').value;
                            const empresa = entry.querySelector('input:nth-child(2)').value;
                            const descricao = entry.querySelector('textarea').value;
                            return (cargo || empresa) ? `<div class="job"><h4>${cargo}</h4><h5>${empresa}</h5><p>${descricao.replace(/\n/g, '<br>')}</p></div>` : '';
                         }).join('')}
            </div>
            <div class="moderno-formacao">
                <h3>${iconHtml(icons.formacao)}Forma√ß√£o Acad√™mica</h3>
                ${Array.from(document.querySelectorAll('#formacao-container .formacao-entry'))
                         .map(entry => {
                            const curso = entry.querySelector('input:nth-child(1)').value;
                            const instituicao = entry.querySelector('input:nth-child(2)').value;
                            const ano = entry.querySelector('input:nth-child(3)').value;
                            return (curso || instituicao) ? `<div class="education"><h4>${curso}</h4><h5>${instituicao} (${ano})</h5></div>` : '';
                         }).join('')}
            </div>
            <div class="moderno-projetos">
                <h3>${iconHtml(icons.projetos)}Projetos</h3>
                ${Array.from(document.querySelectorAll('#projetos-container .projeto-entry'))
                         .map(entry => {
                            const nome = entry.querySelector('input:nth-child(1)').value;
                            const link = entry.querySelector('input:nth-child(2)').value;
                            const descricao = entry.querySelector('textarea').value;
                            return (nome) ? `<div class="job"><h4>${nome}</h4>${link ? `<h5><a href="${link}" target="_blank">${link}</a></h5>` : ''}<p>${descricao.replace(/\n/g, '<br>')}</p></div>` : '';
                         }).join('')}
            </div>
             <div class="moderno-links">
                <h3>${iconHtml(icons.links)}Links</h3>
                <ul>
                ${Array.from(document.querySelectorAll('#links-container .link-entry'))
                         .map(entry => {
                            const nome = entry.querySelector('input:nth-child(1)').value;
                            const url = entry.querySelector('input:nth-child(2)').value;
                            return (nome && url) ? `<li><a href="${url}" target="_blank">${nome}</a></li>` : '';
                         }).join('')}
                </ul>
            </div>
        </div>
    `;
  }

  previewElement.innerHTML = html;
}

// Exportar PDF
async function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    // --- Configura√ß√µes ---
    const margin = 15;
    const pageWidth = doc.internal.pageSize.getWidth();
    const usableWidth = pageWidth - 2 * margin;
    let y = margin;
    const lineHeight = 6;
    const accentColor = document.getElementById('accent-color').value;

    // --- Coleta de Dados ---
    const nome = document.getElementById('nome').value;
    const email = document.getElementById('email').value;
    const telefone = document.getElementById('telefone').value;
    const resumo = document.getElementById('resumo').value;
    const profilePicUrl = document.getElementById('profilePicUrl').value;
    const idiomas = document.getElementById('idiomas').value;

    // --- Fun√ß√£o Auxiliar ---
    const addText = (text, options, isTitle = false) => {
        if (y > (doc.internal.pageSize.getHeight() - margin)) {
            doc.addPage();
            y = margin;
        }
        doc.setFont(options.font || 'helvetica', options.style || 'normal');
        doc.setFontSize(options.size || 12);
        doc.setTextColor(options.color || '#000000');

        const lines = doc.splitTextToSize(text, usableWidth);
        doc.text(lines, margin, y);
        y += (lines.length * lineHeight) + (isTitle ? 3 : 4);
    };

    try {
        // --- Constru√ß√£o do PDF ---
        if (profilePicUrl) {
            try {
                const imgData = await imageUrlToBase64(profilePicUrl);
                doc.addImage(imgData, 'JPEG', pageWidth - margin - 35, margin, 30, 30);
            } catch (e) { console.error("Erro ao adicionar imagem:", e); }
        }

        addText(nome, { size: 24, color: accentColor, style: 'bold' });
        y -= 5;
        addText(`${email} | ${telefone}`, { size: 11, style: 'italic', color: '#555555' });
        doc.setDrawColor(accentColor);
        doc.line(margin, y, pageWidth - margin, y);
        y += 10;

        if (resumo) {
            addText('Resumo Profissional', { size: 16, color: accentColor, style: 'bold' }, true);
            addText(resumo, { size: 11 });
        }

        const sections = [
            { id: 'experiencias-container', title: 'Experi√™ncias' },
            { id: 'formacao-container', title: 'Forma√ß√£o Acad√™mica' },
            { id: 'projetos-container', title: 'Projetos' },
            { id: 'habilidades-container', title: 'Habilidades' },
            { id: 'links-container', title: 'Links' }
        ];

        sections.forEach(section => {
            const container = document.getElementById(section.id);
            const entries = Array.from(container.children);
            if (entries.length > 0 && entries[0].querySelector('input, textarea').value) {
                addText(section.title, { size: 16, color: accentColor, style: 'bold' }, true);
                entries.forEach(entry => {
                    let entryText = '';
                    if (section.id === 'experiencias-container') {
                        const cargo = entry.querySelector('input:nth-child(1)').value;
                        const empresa = entry.querySelector('input:nth-child(2)').value;
                        const desc = entry.querySelector('textarea').value;
                        entryText = `${cargo || ''} em ${empresa || ''}\n${desc || ''}`;
                    } else if (section.id === 'formacao-container') {
                        const curso = entry.querySelector('input:nth-child(1)').value;
                        const inst = entry.querySelector('input:nth-child(2)').value;
                        const ano = entry.querySelector('input:nth-child(3)').value;
                        entryText = `${curso || ''} - ${inst || ''} (${ano || ''})`;
                    } else if (section.id === 'projetos-container') {
                        const nome = entry.querySelector('input:nth-child(1)').value;
                        const link = entry.querySelector('input:nth-child(2)').value;
                        const desc = entry.querySelector('textarea').value;
                        entryText = `${nome || ''}${link ? ` (${link})` : ''}\n${desc || ''}`;
                    } else {
                        const inputs = entry.querySelectorAll('input, textarea');
                        entryText = Array.from(inputs).map(i => i.value).join(' - ');
                    }
                    addText(`‚Ä¢ ${entryText.trim()}`, { size: 11 });
                });
            }
        });

        if (idiomas.trim()) {
            addText('Idiomas', { size: 16, color: accentColor, style: 'bold' }, true);
            addText(idiomas, { size: 11 });
        }

        doc.save('curriculo.pdf');

    } catch (error) {
        console.error("Erro ao gerar PDF programaticamente:", error);
        alert("Ocorreu um erro ao gerar o PDF.");
    }
}

// Helper para converter URL de imagem para Base64
async function imageUrlToBase64(url) {
    // Adiciona um par√¢metro para evitar problemas de cache com CORS
    const response = await fetch(url, { cache: 'no-cache' });
    const blob = await response.blob();
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

// Exportar DOCX
async function exportarDOCX() {
    const previewElement = document.getElementById('preview');
    const elementClone = previewElement.cloneNode(true);

    if (typeof docshift === 'undefined') {
        alert('A biblioteca de exporta√ß√£o DOCX n√£o foi carregada. Tente recarregar a p√°gina.');
        return;
    }

    try {
        // 1. Wait for all fonts to be loaded
        await document.fonts.ready;
        console.log("Fonts loaded for DOCX export.");

        // 2. Convert images to Base64
        const images = Array.from(elementClone.getElementsByTagName('img'));
        const conversionPromises = images.map(async (img) => {
            if (img.src && img.src.startsWith('http')) {
                try {
                    // Usar um proxy CORS se necess√°rio, mas primeiro tentar direto
                    const dataUrl = await imageUrlToBase64(img.src);
                    img.src = dataUrl;
                } catch (e) {
                    console.error('N√£o foi poss√≠vel converter a imagem para Base64:', img.src, e);
                    img.style.display = 'none'; // Oculta a imagem se a convers√£o falhar
                }
            }
        });

        await Promise.all(conversionPromises);

        const docxBlob = await docshift.toDocx(elementClone.innerHTML);

        const url = URL.createObjectURL(docxBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'curriculo.docx';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

    } catch (error) {
        console.error('Erro ao exportar para DOCX:', error);
        alert('Ocorreu um erro ao gerar o arquivo DOCX.');
    }
}

// --- Fun√ß√µes de Persist√™ncia (Salvar/Carregar) ---

function novoCurriculo() {
    // Limpa o formul√°rio para um novo curr√≠culo
    document.getElementById('cvForm').reset();
    document.getElementById('profilePicUrl').value = '';
    document.getElementById('profilePicPreview').src = '';
    document.getElementById('profilePicPreview').style.display = 'none';

    // Limpa os containers din√¢micos
    document.getElementById('experiencias-container').innerHTML = '';
    document.getElementById('formacao-container').innerHTML = '';
    document.getElementById('habilidades-container').innerHTML = '';
    document.getElementById('projetos-container').innerHTML = '';
    document.getElementById('links-container').innerHTML = '';

    // Limpa a sele√ß√£o do curr√≠culo salvo
    document.getElementById('savedCvSelect').value = '';

    // Adiciona um conjunto de campos em branco para come√ßar
    adicionarExperiencia();
    adicionarFormacao();
    adicionarHabilidade();
    adicionarProjeto();
    adicionarLink();

    gerarPreview();
    alert("Formul√°rio limpo. Pronto para um novo curr√≠culo!");
}

function salvarComoNovo() {
    // For√ßa a cria√ß√£o de um novo curr√≠culo limpando o ID selecionado
    document.getElementById('savedCvSelect').value = '';
    salvarCurriculo();
}

function salvarCurriculo() {
    const user = auth.currentUser;
    if (!user) {
        alert("Por favor, fa√ßa login para salvar seu curr√≠culo.");
        return;
    }

    const curriculoData = {
        template: document.getElementById('template-select').value,
        accentColor: document.getElementById('accent-color').value,
        fontFamily: document.getElementById('font-select').value,
        marginValue: document.getElementById('margin-slider').value,
        spacingValue: document.getElementById('spacing-slider').value,
        icons: {
            email: document.getElementById('email-icon').value,
            telefone: document.getElementById('telefone-icon').value,
            resumo: document.getElementById('resumo-icon').value,
            experiencias: document.getElementById('experiencias-icon').value,
            formacao: document.getElementById('formacao-icon').value,
            habilidades: document.getElementById('habilidades-icon').value,
            idiomas: document.getElementById('idiomas-icon').value,
            projetos: document.getElementById('projetos-icon').value,
            links: document.getElementById('links-icon').value
        },
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        telefone: document.getElementById('telefone').value,
        resumo: document.getElementById('resumo').value,
        idiomas: document.getElementById('idiomas').value,
        profilePicUrl: document.getElementById('profilePicUrl').value,
        experiencias: [],
        formacao: [],
        habilidades: [],
        projetos: [],
        links: [],
        salvoEm: new Date()
    };

    document.querySelectorAll('#experiencias-container .experiencia-entry').forEach(entry => {
        curriculoData.experiencias.push({
            cargo: entry.querySelector('input:nth-child(1)').value,
            empresa: entry.querySelector('input:nth-child(2)').value,
            descricao: entry.querySelector('textarea').value
        });
    });
    document.querySelectorAll('#formacao-container .formacao-entry').forEach(entry => {
        curriculoData.formacao.push({
            curso: entry.querySelector('input:nth-child(1)').value,
            instituicao: entry.querySelector('input:nth-child(2)').value,
            ano: entry.querySelector('input:nth-child(3)').value
        });
    });
    document.querySelectorAll('#habilidades-container .habilidade-entry input[type="text"]').forEach(entry => {
        if (entry.value.trim()) curriculoData.habilidades.push(entry.value.trim());
    });

    document.querySelectorAll('#projetos-container .projeto-entry').forEach(entry => {
        curriculoData.projetos.push({
            nome: entry.querySelector('input:nth-child(1)').value,
            link: entry.querySelector('input:nth-child(2)').value,
            descricao: entry.querySelector('textarea').value
        });
    });

    document.querySelectorAll('#links-container .link-entry').forEach(entry => {
        curriculoData.links.push({
            nome: entry.querySelector('input:nth-child(1)').value,
            url: entry.querySelector('input:nth-child(2)').value
        });
    });

    const cvId = document.getElementById('savedCvSelect').value;

    if (cvId) {
        // Atualizar curr√≠culo existente
        db.collection('usuarios').doc(user.uid).collection('curriculos').doc(cvId).set(curriculoData, { merge: true })
            .then(() => {
                alert(`Curr√≠culo atualizado com sucesso!`);
                carregarListaCurriculos(); // Atualiza a lista para refletir a nova data
            })
            .catch(error => console.error("Erro ao atualizar: ", error));
    } else {
        // Adicionar novo curr√≠culo
        db.collection('usuarios').doc(user.uid).collection('curriculos').add(curriculoData)
            .then((docRef) => {
                alert(`Curr√≠culo salvo com sucesso!`);
                // Seleciona o novo curr√≠culo na lista
                carregarListaCurriculos().then(() => {
                    document.getElementById('savedCvSelect').value = docRef.id;
                });
            })
            .catch(error => console.error("Erro ao salvar: ", error));
    }
}

function carregarListaCurriculos() {
    const user = auth.currentUser;
    if (!user) return Promise.resolve(); // Return a resolved promise if no user

    const savedCvArea = document.getElementById('savedCvArea');
    const select = document.getElementById('savedCvSelect');
    const currentVal = select.value; // Preserve current selection
    select.innerHTML = '<option value="">Selecione um curr√≠culo...</option>';

    // Return the promise chain
    return db.collection('usuarios').doc(user.uid).collection('curriculos').orderBy('salvoEm', 'desc').get()
        .then(snapshot => {
            if (snapshot.empty) {
                savedCvArea.style.display = 'none';
                return;
            }

            snapshot.forEach(doc => {
                const cv = doc.data();
                const option = document.createElement('option');
                option.value = doc.id;
                const dataFormatada = cv.salvoEm.toDate().toLocaleString('pt-BR');
                option.textContent = `${cv.nome || 'Curr√≠culo'} - ${dataFormatada}`;
                select.appendChild(option);
            });
            savedCvArea.style.display = 'block';
            if (document.querySelector(`#savedCvSelect option[value='${currentVal}']`)) {
                select.value = currentVal; // Restore selection if it still exists
            }
        })
        .catch(error => {
            console.error("Erro ao carregar lista de curr√≠culos: ", error);
            // Re-throw the error so the caller knows something went wrong
            throw error;
        });
}

function carregarCurriculo() {
    const user = auth.currentUser;
    const cvId = document.getElementById('savedCvSelect').value;
    if (!user || !cvId) return;

    db.collection('usuarios').doc(user.uid).collection('curriculos').doc(cvId).get()
        .then(doc => {
            if (!doc.exists) {
                alert("Curr√≠culo n√£o encontrado.");
                return;
            }
            const cv = doc.data();

            // Limpar campos existentes
            document.getElementById('experiencias-container').innerHTML = '';
            document.getElementById('formacao-container').innerHTML = '';
            document.getElementById('habilidades-container').innerHTML = '';
            document.getElementById('projetos-container').innerHTML = '';
            document.getElementById('links-container').innerHTML = '';

            // Preencher campos
            document.getElementById('template-select').value = cv.template || 'classico';
            document.getElementById('accent-color').value = cv.accentColor || '#4a90e2';
            document.getElementById('font-select').value = cv.fontFamily || 'lato';
            document.getElementById('margin-slider').value = cv.marginValue || '30';
            document.getElementById('spacing-slider').value = cv.spacingValue || '25';

            if (cv.icons) {
                document.getElementById('email-icon').value = cv.icons.email || '';
                document.getElementById('telefone-icon').value = cv.icons.telefone || '';
                document.getElementById('resumo-icon').value = cv.icons.resumo || '';
                document.getElementById('experiencias-icon').value = cv.icons.experiencias || '';
                document.getElementById('formacao-icon').value = cv.icons.formacao || '';
                document.getElementById('habilidades-icon').value = cv.icons.habilidades || '';
                document.getElementById('idiomas-icon').value = cv.icons.idiomas || '';
                document.getElementById('projetos-icon').value = cv.icons.projetos || '';
                document.getElementById('links-icon').value = cv.icons.links || '';
            }

            document.getElementById('nome').value = cv.nome || '';
            document.getElementById('email').value = cv.email || '';
            document.getElementById('telefone').value = cv.telefone || '';
            document.getElementById('resumo').value = cv.resumo || '';
            document.getElementById('idiomas').value = cv.idiomas || '';
            document.getElementById('profilePicUrl').value = cv.profilePicUrl || '';

            // Atualizar a preview da foto no formul√°rio
            const profilePicPreview = document.getElementById('profilePicPreview');
            if (cv.profilePicUrl) {
                profilePicPreview.src = cv.profilePicUrl;
                profilePicPreview.style.display = 'block';
            } else {
                profilePicPreview.src = '';
                profilePicPreview.style.display = 'none';
            }

            cv.experiencias.forEach(exp => {
                adicionarExperiencia();
                const newEntry = document.querySelector('#experiencias-container .experiencia-entry:last-child');
                newEntry.querySelector('input:nth-child(1)').value = exp.cargo;
                newEntry.querySelector('input:nth-child(2)').value = exp.empresa;
                newEntry.querySelector('textarea').value = exp.descricao;
            });
            cv.formacao.forEach(form => {
                adicionarFormacao();
                const newEntry = document.querySelector('#formacao-container .formacao-entry:last-child');
                newEntry.querySelector('input:nth-child(1)').value = form.curso;
                newEntry.querySelector('input:nth-child(2)').value = form.instituicao;
                newEntry.querySelector('input:nth-child(3)').value = form.ano;
            });
            cv.habilidades.forEach(hab => {
                adicionarHabilidade();
                const newEntry = document.querySelector('#habilidades-container .habilidade-entry:last-child');
                newEntry.querySelector('input[type="text"]').value = hab;
            });

            if (cv.projetos) {
                cv.projetos.forEach(proj => {
                    adicionarProjeto();
                    const newEntry = document.querySelector('#projetos-container .projeto-entry:last-child');
                    newEntry.querySelector('input:nth-child(1)').value = proj.nome;
                    newEntry.querySelector('input:nth-child(2)').value = proj.link;
                    newEntry.querySelector('textarea').value = proj.descricao;
                });
            }

            if (cv.links) {
                cv.links.forEach(link => {
                    adicionarLink();
                    const newEntry = document.querySelector('#links-container .link-entry:last-child');
                    newEntry.querySelector('input:nth-child(1)').value = link.nome;
                    newEntry.querySelector('input:nth-child(2)').value = link.url;
                });
            }

            gerarPreview(); // Atualiza o preview com os dados carregados
        });
}

function deletarCurriculo() {
    const user = auth.currentUser;
    const cvId = document.getElementById('savedCvSelect').value;
    if (!user || !cvId) return;

    if (confirm("Tem certeza que deseja deletar este curr√≠culo? Esta a√ß√£o n√£o pode ser desfeita.")) {
        db.collection('usuarios').doc(user.uid).collection('curriculos').doc(cvId).delete()
            .then(() => {
                alert("Curr√≠culo deletado com sucesso.");
                carregarListaCurriculos(); // Atualiza a lista
            })
            .catch(error => console.error("Erro ao deletar: ", error));
    }
}

// Comprar Premium (L√≥gica mantida)
function comprarPremium() {
    const user = auth.currentUser;
    if(!user){
        alert("Voc√™ precisa fazer login para comprar Premium.");
        loginGoogle();
        return;
    }
    db.collection('usuarios').doc(user.uid).set({premium:true}, {merge:true})
        .then(()=>alert("Premium ativado!"))
        .catch(err=>alert("Erro: "+err));
}

// Monitorar Status de Autentica√ß√£o e Premium
auth.onAuthStateChanged(user => {
  const savedCvArea = document.getElementById('savedCvArea');
  if(user){
    // Usu√°rio logado
    document.getElementById('userEmail').innerText = user.email;
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'inline';

    // Checar status premium e carregar curr√≠culos
    db.collection('usuarios').doc(user.uid).get().then(doc => {
        if(doc.exists && doc.data().premium){
          console.log("Usu√°rio Premium verificado.");
          document.querySelector('#template-select option[value="moderno"]').disabled = false;
        } else {
          document.querySelector('#template-select option[value="moderno"]').disabled = true;
        }
    });
    carregarListaCurriculos();

  } else {
    // Usu√°rio deslogado
    document.getElementById('userEmail').innerText = '';
    document.getElementById('loginBtn').style.display = 'inline';
    document.getElementById('logoutBtn').style.display = 'none';
    savedCvArea.style.display = 'none'; // Esconde a √°rea de curr√≠culos salvos
    document.querySelector('#template-select option[value="moderno"]').disabled = true;
  }
});

// --- Pr√©-visualiza√ß√£o em Tempo Real ---
document.getElementById('cvForm').addEventListener('input', gerarPreview);

// --- Drag and Drop ---
function inicializarArrastarESoltar() {
    const options = {
        animation: 150,
        ghostClass: 'sortable-ghost',
        handle: '.drag-handle', // Define a al√ßa de arraste
        onEnd: gerarPreview // Atualiza o preview ao final do arraste
    };

    new Sortable(document.getElementById('experiencias-container'), options);
    new Sortable(document.getElementById('formacao-container'), options);
    new Sortable(document.getElementById('habilidades-container'), options);
    new Sortable(document.getElementById('projetos-container'), options);
    new Sortable(document.getElementById('links-container'), options);
}

// Gera um preview inicial ao carregar a p√°gina
window.addEventListener('DOMContentLoaded', () => {
    adicionarExperiencia();
    adicionarFormacao();
    adicionarHabilidade();
    adicionarProjeto();
    adicionarLink();
    gerarPreview();
    inicializarArrastarESoltar(); // Ativa o drag and drop
});
</script>
</body>
</html>
